services:
  # Neo4j Database
  neo4j:
    image: neo4j:5
    container_name: neo4j
    ports:
      - "7687:7687"  # Bolt - accessible from Mac
      - "7474:7474"  # Browser - accessible from Mac
    volumes:
      - neo4j_data:/data  # Docker-managed volume (no macOS file system issues)
      - ./neo4j-init:/backups:ro  # Mount dump file for manual import
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped
    networks:
      - network

  # APIs Container (Backend API + Graph API)
  apis:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.apis
    container_name: apis
    working_dir: /app
    # Ports exposed for local development (workers need direct access)
    ports:
      - "8000:8000"  # Backend API
      - "8001:8001"  # Graph API
    volumes:
      # Persist uploaded articles (survives rebuilds)
      - articles_data:/app/saga-be/data
      # Persist new statistics and logs (for admin dashboard)
      - stats_data:/app/saga-be/stats
      # Persist user data (includes strategies inside users/username/)
      - users_data:/app/saga-be/users
      # NO CODE MOUNTS - code is baked into Docker image
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=neo4j
      - API_KEY=${API_KEY}
      - GRAPH_API_URL=http://localhost:8001
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DISABLE_LOCAL_LLM=${DISABLE_LOCAL_LLM}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - PYTHONUNBUFFERED=1
    depends_on:
      neo4j:
        condition: service_healthy
      # Note: Qdrant dependency removed - vector search is optional, not critical
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - network

  # Main Pipeline Worker (ingest_articles.py - 24/7 topic processing)
  worker-main:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.workers
    container_name: worker-main
    working_dir: /app
    command: ["bash", "/app/victor_deployment/start-main.sh"]
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=neo4j
      - BACKEND_API_URL=http://apis:8000
      - BACKEND_API_KEY=${API_KEY}
      - PYTHONUNBUFFERED=1
      - WORKER_NAME=main-pipeline
      - DISABLE_LOCAL_LLM=${DISABLE_LOCAL_LLM}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_API_KEY=${QDRANT_API_KEY}
    depends_on:
      neo4j:
        condition: service_healthy
      apis:
        condition: service_healthy
      # Note: Qdrant dependency removed - vector search is optional
    restart: unless-stopped
    networks:
      - network

  # Top Sources Worker (ingest_top_sources.py - premium source ingestion)
  worker-sources:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.workers
    container_name: worker-sources
    working_dir: /app
    command: ["bash", "/app/victor_deployment/start-top-sources.sh"]
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=neo4j
      - BACKEND_API_URL=http://apis:8000
      - BACKEND_API_KEY=${API_KEY}
      - PYTHONUNBUFFERED=1
      - WORKER_NAME=top-sources
      - DISABLE_LOCAL_LLM=${DISABLE_LOCAL_LLM}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_API_KEY=${QDRANT_API_KEY}
    depends_on:
      neo4j:
        condition: service_healthy
      apis:
        condition: service_healthy
      # Note: Qdrant dependency removed - vector search is optional
    restart: unless-stopped
    networks:
      - network

  # Frontend
  frontend:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.frontend
    container_name: frontend
    working_dir: /app
    # Use preview mode (serves built files from Dockerfile)
    # command: sh -c "pnpm run dev --host"  # Old: dev mode
    ports:
      - "5173:5173"
    # NO VOLUME MOUNT - code is baked into Docker image
    environment:
      - CI=true
      # Note: VITE_ vars are baked at build time in Dockerfile
      # Runtime SSR uses http://apis:8000/api (hardcoded in lib/api/client.ts)
    depends_on:
      apis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - network

  # Vector Search Database
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:6333/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - network

  # MCP Server (Remote Development Access for Claude Code)
  mcp-server:
    build:
      context: ./mcp
      dockerfile: Dockerfile
    container_name: mcp-server
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Read-only access to codebase
      - /opt/saga-graph:/opt/saga-graph:ro
    environment:
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot_certs:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
      - nginx_logs:/var/log/nginx  # Persist logs for fail2ban
    depends_on:
      apis:
        condition: service_healthy
      frontend:
        condition: service_started
      neo4j:
        condition: service_started
    restart: unless-stopped
    networks:
      - network

  # Fail2ban - Auto-ban malicious IPs
  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    network_mode: host  # Required to manage host iptables
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - fail2ban_data:/data  # Persistent jail database
      - ./fail2ban/jail.d:/etc/fail2ban/jail.d:ro
      - ./fail2ban/filter.d:/etc/fail2ban/filter.d:ro
      - nginx_logs:/var/log/nginx:ro  # Read nginx logs
    environment:
      - TZ=UTC
      - F2B_LOG_LEVEL=INFO
      - F2B_DB_PURGE_AGE=14d
    restart: unless-stopped

networks:
  network:
    driver: bridge

volumes:
  neo4j_data:
    driver: local
  articles_data:
    driver: local
  stats_data:
    driver: local
  users_data:
    driver: local
  certbot_certs:
    driver: local
  certbot_www:
    driver: local
  qdrant_data:
    driver: local
  nginx_logs:
    driver: local
  fail2ban_data:
    driver: local
