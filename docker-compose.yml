services:
  # Neo4j Database
  neo4j:
    image: neo4j:5
    container_name: saga-neo4j
    ports:
      - "7687:7687"  # Bolt - accessible from Mac
      - "7474:7474"  # Browser - accessible from Mac
    volumes:
      - neo4j_data:/data  # Docker-managed volume (no macOS file system issues)
      - ./neo4j-init:/backups:ro  # Mount dump file for manual import
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped
    networks:
      - saga-network

  # APIs Container (Backend API + Graph API)
  saga-apis:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.apis
    container_name: saga-apis
    working_dir: /app
    # Ports exposed for local development (workers need direct access)
    ports:
      - "8000:8000"  # Backend API
      - "8001:8001"  # Graph API
    volumes:
      # Persist uploaded articles (survives rebuilds)
      - articles_data:/app/saga-be/data
      # Persist new statistics and logs (for admin dashboard)
      - stats_data:/app/saga-be/stats
      # Persist user data (includes strategies inside users/username/)
      - users_data:/app/saga-be/users
      # NO CODE MOUNTS - code is baked into Docker image
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=neo4j
      - API_KEY=${API_KEY}
      - GRAPH_API_URL=http://localhost:8001
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DISABLE_LOCAL_LLM=${DISABLE_LOCAL_LLM}
      - PYTHONUNBUFFERED=1
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - saga-network

  # Main Pipeline Worker (ingest_articles.py - 24/7 topic processing)
  saga-worker-main:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.workers
    container_name: saga-worker-main
    working_dir: /app
    command: ["bash", "/app/victor_deployment/start-main.sh"]
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=neo4j
      - BACKEND_API_URL=http://saga-apis:8000
      - BACKEND_API_KEY=${API_KEY}
      - PYTHONUNBUFFERED=1
      - WORKER_NAME=main-pipeline
      - DISABLE_LOCAL_LLM=${DISABLE_LOCAL_LLM}
    depends_on:
      neo4j:
        condition: service_healthy
      saga-apis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - saga-network

  # Top Sources Worker (ingest_top_sources.py - premium source ingestion)
  saga-worker-sources:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.workers
    container_name: saga-worker-sources
    working_dir: /app
    command: ["bash", "/app/victor_deployment/start-top-sources.sh"]
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=neo4j
      - BACKEND_API_URL=http://saga-apis:8000
      - BACKEND_API_KEY=${API_KEY}
      - PYTHONUNBUFFERED=1
      - WORKER_NAME=top-sources
      - DISABLE_LOCAL_LLM=${DISABLE_LOCAL_LLM}
    depends_on:
      neo4j:
        condition: service_healthy
      saga-apis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - saga-network

  # Frontend
  frontend:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.frontend
    container_name: saga-frontend
    working_dir: /app
    # Use preview mode (serves built files from Dockerfile)
    # command: sh -c "pnpm run dev --host"  # Old: dev mode
    ports:
      - "5173:5173"
    # NO VOLUME MOUNT - code is baked into Docker image
    environment:
      - CI=true
      - VITE_API_BASE_URL=/api
      - VITE_API_KEY=785fc6c1647ff650b6b611509cc0a8f47009e6b743340503519d433f111fcf12
    restart: unless-stopped
    networks:
      - saga-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: saga-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot_certs:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
    depends_on:
      saga-apis:
        condition: service_healthy
      frontend:
        condition: service_started
      neo4j:
        condition: service_started
    restart: unless-stopped
    networks:
      - saga-network

networks:
  saga-network:
    driver: bridge

volumes:
  neo4j_data:
    driver: local
  articles_data:
    driver: local
  stats_data:
    driver: local
  users_data:
    driver: local
  certbot_certs:
    driver: local
  certbot_www:
    driver: local
  # Code volumes removed - code is baked into Docker images, not mounted
