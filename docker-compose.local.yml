version: '3.8'

services:
  # Local Neo4j - 100% backup of server graph
  local-neo4j:
    image: neo4j:5
    container_name: saga-local-neo4j
    ports:
      - "7688:7687"  # Bolt (different port to avoid conflict)
      - "7475:7474"  # Browser (different port to avoid conflict)
    volumes:
      # Docker-managed volume (Mac-safe, persists across rebuilds)
      - local_neo4j_data:/data
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped
    networks:
      - saga-local-network
  
  # Local Backend API - 100% backup of articles
  local-backend:
    build:
      context: ..
      dockerfile: victor_deployment/Dockerfile.apis
    container_name: saga-local-backend
    ports:
      - "8002:8000"  # Backend API (different port)
      - "8003:8001"  # Graph API (different port)
    volumes:
      # Docker-managed volumes (Mac-safe, persist across rebuilds)
      - local_articles_data:/app/saga-be/data/raw_news
      - local_master_stats:/app/graph-functions/master_stats
      - local_master_logs:/app/graph-functions/master_logs
    environment:
      - NEO4J_URI=bolt://local-neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=neo4j
      - API_KEY=${API_KEY}
      - GRAPH_API_URL=http://localhost:8001
      - PYTHONUNBUFFERED=1
    depends_on:
      local-neo4j:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - saga-local-network
  
  # Sync service - mirrors server to local
  saga-sync:
    image: python:3.11-slim
    container_name: saga-sync
    working_dir: /app
    command: >
      sh -c "pip install -q neo4j==5.14.0 requests==2.31.0 python-dotenv==1.0.0 &&
             python -u sync_bidirectional.py --continuous --interval 300"
    volumes:
      # Mount sync script (read-only)
      - ../graph-functions/src/sync_server_and_local:/app:ro
    environment:
      # Local (backup)
      - NEO4J_URI=bolt://local-neo4j:7687
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - LOCAL_BACKEND_API=http://local-backend:8000/api
      
      # Cloud (master)
      - CLOUD_SERVER_IP=${SERVER_IP}
      - CLOUD_NEO4J_URI=bolt://${SERVER_IP}:7687
      - CLOUD_NEO4J_USER=${NEO4J_USER}
      - CLOUD_NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - CLOUD_BACKEND_API=http://${SERVER_IP}/api
      
      # API key
      - BACKEND_API_KEY=${API_KEY}
    depends_on:
      local-neo4j:
        condition: service_healthy
      local-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - saga-local-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  saga-local-network:
    driver: bridge

volumes:
  # All Docker-managed volumes (Mac-safe, persist across rebuilds)
  local_neo4j_data:
    driver: local
  local_articles_data:
    driver: local
  local_master_stats:
    driver: local
  local_master_logs:
    driver: local
