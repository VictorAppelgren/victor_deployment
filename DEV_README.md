# üõ†Ô∏è Local Development Guide

Two ways to develop: **Python workers** (fast) or **Full Docker** (testing).

---

## üöÄ Quick Start - Local Development (Recommended)

**Single command - instant code changes:**

```bash
cd victor_deployment

# Kill all sync processes 
pkill -9 -f sync_bidirectional.py

./dev.sh
```

**What it does:**
- ‚úÖ Starts local Neo4j backup (Docker)
- ‚úÖ Starts background sync from server
- ‚úÖ Sets up Python venv
- ‚úÖ Drops you in terminal ready to code

**Run your worker:**
```bash
python entrypoints/ingest_articles.py      # Main pipeline
python entrypoints/ingest_top_sources.py   # Top sources
python entrypoints/write_all.py            # Write server
```

**Make changes:**
- Edit code ‚Üí Ctrl+C ‚Üí restart script ‚Üí Changes apply instantly!

**View synced data:**
```bash
ls -lh master_stats/              # Stats from server
tail -f master_logs/*.log         # Logs from server
tail -f ../victor_deployment/sync.log  # Sync status
```

**Switch target:**
```bash
# Edit victor_deployment/.env.local
WORKER_TARGET=server  # Work on production (default)
WORKER_TARGET=local   # Work on local backup

# LLM Configuration (MacBook has local LLM, server doesn't)
DISABLE_LOCAL_LLM=false  # MacBook: use local LLM (default)
DISABLE_LOCAL_LLM=true   # Override: force external LLMs only

# Restart to apply changes
./dev.sh
```

**Manage background sync:**
```bash
# Check if running
ps aux | grep sync_bidirectional

# View sync log
tail -f ../victor_deployment/sync.log

# Stop sync (kills ALL sync processes)
pkill -9 -f sync_bidirectional.py
rm -rf ../victor_deployment/sync.lock ../victor_deployment/sync.pid

# Restart sync
./dev.sh  # Will detect it's not running and start it
```

---

## üê≥ Full Docker Stack (Testing Only)

**When to use:** Testing complete system, debugging frontend/backend integration.

**Start everything (first time or after pulling changes):**
```bash
cd victor_deployment

# Setup local nginx config (HTTP only, no SSL)
cp nginx/nginx-http-only.conf nginx/nginx.conf

# Start all services
docker compose up -d
```

**Quick start (nginx already configured):**
```bash
cd victor_deployment
docker compose up -d
```

**Access:**
- App: http://localhost
- Neo4j: http://localhost:7474
- Backend API: http://localhost:8000

**Rebuild after changes:**
```bash
# Backend/Graph API
docker compose down apis && docker compose build --no-cache apis
docker compose restart apis

# Frontend
docker compose down frontend && docker compose build --no-cache frontend
docker compose restart frontend

# nginx
docker compose down nginx && docker compose build --no-cache nginx && docker compose restart nginx

# Combined: Frontend + APIs (for full testing)
docker compose down frontend apis && docker compose build --no-cache frontend apis && docker compose up -d frontend apis

# All in one (just frontend)
docker compose down frontend && docker compose build --no-cache frontend && docker compose up -d frontend

# Workers
docker compose down worker-main && docker compose build --no-cache worker-main
docker compose restart worker-main

# Check running containers
docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

**Troubleshooting After Rebuild:**
```bash
# View API logs (last 100 lines)
docker logs --tail=100 apis

# View frontend logs
docker logs frontend

# Check running containers
docker ps -a

# Check API health
curl -I http://localhost:8000/health

# Check frontend connectivity
curl -I http://localhost

# Full system status
docker compose ps
```

Common issues:
1. Login failures? Check API logs for auth errors
2. Frontend not loading? Verify container is running (`docker ps`)
3. CORS issues? Ensure `VITE_API_BASE_URL` is correct in frontend
4. Database connection? Check Neo4j logs (`docker logs neo4j`)

**Stop:**
```bash
docker compose down
```

---

## üìù Environment Files Explained

**Three environment files, each with a clear purpose:**

### 1. `victor_deployment/.env.local` (Local Development Config)
- **Purpose:** Your personal development settings
- **Git:** ‚ùå Ignored (never committed)
- **Used by:** `dev.sh` script
- **Key settings:**
  - `WORKER_TARGET=server` or `local` (where to connect)
  - `DISABLE_LOCAL_LLM=false` (MacBook has local LLM)
  - API keys (personal)

### 2. `victor_deployment/.env` (Server Production Config)
- **Purpose:** Production server settings
- **Git:** ‚úÖ Committed (safe, no secrets)
- **Used by:** Docker Compose on server
- **Key settings:**
  - `DISABLE_LOCAL_LLM=true` (server has no local LLM)
  - Neo4j credentials
  - API keys (production)

### 3. `graph-functions/.env` (Auto-Generated Runtime)
- **Purpose:** Runtime environment for Python workers
- **Git:** ‚ùå Ignored (auto-generated)
- **Generated by:** `dev.sh` (local) or baked into Docker (server)
- **Used by:** All Python scripts via `utils/env_loader.py`

**How it works:**
```
Local Dev:  .env.local ‚Üí dev.sh ‚Üí graph-functions/.env ‚Üí Python workers
Server:     .env ‚Üí Docker Compose ‚Üí containers ‚Üí Python workers
```

**The `DISABLE_LOCAL_LLM` flow:**
- MacBook: `.env.local` has `false` ‚Üí `dev.sh` copies to `graph-functions/.env` ‚Üí workers use local LLM ‚úÖ
- Server: `.env` has `true` ‚Üí Docker passes to containers ‚Üí workers use external LLMs only ‚úÖ

---

## üîÑ Background Sync

**What gets synced from server:**
- Neo4j graph (full backup)
- Articles (bidirectional)
- Stats files
- Log files (last 7 days)

**Frequency:** Every 5 minutes

**Monitor:**
```bash
tail -f ../victor_deployment/sync.log
```

**Stop sync:**
```bash
kill $(cat ../victor_deployment/sync.pid)
```

---

## üìä Access Points

**Local Development (dev.sh):**
- Worker connects to: Production server (167.172.185.204)
- Local backup Neo4j: http://localhost:7475
- Stats/Logs: Direct filesystem (`master_stats/`, `master_logs/`)

**Full Docker Stack:**
- App: http://localhost
- Neo4j: http://localhost:7474
- Backend API: http://localhost:8000

---

## üêõ Quick Troubleshooting

**Sync not working:**
```bash
tail -f ../victor_deployment/sync.log
kill $(cat ../victor_deployment/sync.pid)
./dev.sh
```

**Worker can't connect:**
```bash
# Check target
cat ../victor_deployment/.env.local | grep WORKER_TARGET

# Verify server
curl http://167.172.185.204/api/health
```

**Port conflict:**
```bash
lsof -i :7688  # Local Neo4j
docker stop local-neo4j
./dev.sh
```

---

## ‚úÖ Summary

**Daily Development:**
```bash
./dev.sh ‚Üí python entrypoints/ingest_articles.py
```

**Testing Full Stack:**
```bash
docker compose up -d
```

**Simple, fast, matches production!** üöÄ
